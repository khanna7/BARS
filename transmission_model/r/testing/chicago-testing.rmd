BARS Transmission Model: Chicago 
========================================================
-- Aditya, Nikki, Nick, and Jonathan 

Chicago model: with main and casual partnerships

```{r}
rm(list=ls())
## libraries
suppressPackageStartupMessages(library(network))
suppressPackageStartupMessages(library(ergm))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(dplyr))
```
and read in the various datasets that are generated:

```{r}
## data
net <- readRDS("../../Release/output/main_network_15000.RDS") #main network at the end
cas_net <- readRDS("../../Release/output/main_network_15000.RDS")#casual network at the end

biom_data <- read.csv("../../Release/output/biomarker_log_36.csv")
counts_data <- read.csv("../../Release/output/counts_36.csv")
inf_event_data <- read.csv("../../Release/output/infection_events_36.csv")
death_data <- read.csv("../../Release/output/death_events_36.csv")
partnership_event_data <- read.csv("../../Release/output/partnership_events_36.csv")

input_parameter_data <- source("../common/chicago_parameters.R")
```

These datasets include the sexual network at the 10,000th (i.e. last) time step, biomarker data with detailed trajectories, infection, death and partnership events, and counts of various quantities at each time step.

# Results
## Demography
We first compute the annual growth rate.  

```{r, results='show'}
  final.vcount <- network.size(net)
  init.vcount <- 5000
  
  annual.growth.rate <- (((final.vcount)/init.vcount)^(1/(10e3/365))-1)*100 #log scale
```
The final population size is `r final.vcount`, corresponding to a growth rate of 
`r round(annual.growth.rate, 2)`%. (The rate of entry of new individuals is a free parameter, and will be adjusted to reflect data form the three cities). 

The age distribution at the end of the simulation is below.


```{r, results='show'}
age <- net%v%"age"
plot(
  qplot(age, geom="histogram", binwidth=5, 
       col=I("red"), 
       alpha=I(.2))
  )
```

## Prevalence
   The overall prevalence was 
   ```{r, results='show'}
   infected <- which(net %v% "inf.status" == 1)
   prev <- length(infected)/final.vcount*100
   prev
   ```
  about `r round(prev, 1)`%.  The prevalence over time is shown below.
  
   ```{r, results='show'}
   counts_data <- counts_data[-1,]
   ggplot(counts_data/365, aes(x=time, y=(vertex_count-uninfected)/vertex_count))+
         geom_line()+
         scale_y_continuous(limits=c(0,1))+
         ylab("Prevalence")+
         xlab("Time (years)")
   ```
   
## Incidence
   ```{r, results='asis', echo=FALSE}
   new_inf_per_timestep <- counts_data$infected_via_transmission[-1] 
                                                      #ignore 1st timepoint
   susc_per_timestep <- (counts_data$uninfected[-1] - counts_data$entries[-1])
                                                      #ignore 1st timepoint

   summ_inc_per_timestep <- (summary(new_inf_per_timestep/susc_per_timestep))
   
     inc_per_timestep <- new_inf_per_timestep/susc_per_timestep
     inc_per_year <- split(inc_per_timestep, 
                            ceiling(seq_along(inc_per_timestep)/365)
                            )
     mean_inc_per_year <- unlist(lapply(inc_per_year, mean))*365
     
       annual_inc_data <- cbind(1:length(mean_inc_per_year), (mean_inc_per_year))
        annual_inc_data <- as.data.frame(annual_inc_data)                                
        colnames(annual_inc_data) <- c("year", "ann_inc_pp_py")
        ggplot(annual_inc_data, aes(year, ann_inc_pp_py*100))+
         geom_line()+xlab("Year")+ylab("Incidence Rate (per 100 person years)")+
         scale_y_continuous(limits=c(0,12))
     
     ```

  
  The mean annual incidence is `r round(summ_inc_per_timestep[4]*365*100, 2)`%, and the annual incidence rates over the course of the simulation are shown above.
  
  
## Sexual Networks

### Main Partnerships

#### Mean degree. 
The target main mean degree is `r round(nedges*2/n, 2)` and a plot of the simulated mean
degree, over the course of the simulation, is below.

```{r, echo=FALSE, show='asis'}
   #counts_data <- rbind(counts_data, nedges)
   #type <- c(rep("simulated", (nrow(counts_data)-1)), rep("target", 1))
   #counts_data <- as.data.frame(cbind(counts_data, type))
   
  ggplot(counts_data)+
        geom_line(aes(x=time, y=main_edge_count*2/vertex_count))+
        geom_line(aes(x=time, y=nedges*2/n))+
        xlab("time step")+ylab("mean degree")
```

#### Degree distribution.
The simulated and target momentary degree distributions are below.
```{r, echo=FALSE, results='show'}
sim_deg_dist <- degreedist(net)
names(sim_deg_dist) <- c("0", "1", "2")
target_deg_dist <- deg_seq
names(target_deg_dist) <- c("0", "1", "2")

main_deg_dist_data <- cbind(t(sim_deg_dist[1:3]), t(target_deg_dist))
main_deg_dist_data <- melt(main_deg_dist_data, id.vars=c("degree0, degree1, degree2"))
main_deg_dist_data <- cbind(main_deg_dist_data, c(rep("simulated", 3), rep("target", 3)))
colnames(main_deg_dist_data) <- c("ID", "degree", "value", "type")

ggplot(main_deg_dist_data, aes(x=degree, y=value, fill=type))+
  geom_bar(position="dodge", stat="identity")+
  ylab("Number of Agents")

```

#### Partnership duration.
```{r}
main_partnerships <- partnership_event_data[which(partnership_event_data$network_type == 0),]
dim(main_partnerships)

dis_main_ptshps <- distinct(select(main_partnerships, p1, p2))
sim_dur_form_dissolved <- NULL

for (i in 1:nrow(dis_main_ptshps)){
  occur <- 
    intersect(which(main_partnerships$p1 == dis_main_ptshps$p1[i]),
            which(main_partnerships$p2 == dis_main_ptshps$p2[i])
            )
  
  if (length(occur) == 2){
    
    duration_new <- main_partnerships$tick[max(occur)] - main_partnerships$tick[min(occur)]
    
    sim_dur_form_dissolved <- c(sim_dur_form_dissolved, duration_new)
  
    }

  }

main_sim_duration_form_dissolved <- sim_dur_form_dissolved
summary(main_sim_duration_form_dissolved)
hist(main_sim_duration_form_dissolved)
```

### Casual Partnerships

#### Mean degree. 
The target casual mean degree is `r round(cas_n_edges*2/n, 2)` and a plot of the simulated mean
degree, over the course of the simulation, is below.

```{r, echo=FALSE, show='asis'}
   
  ggplot(counts_data)+
        geom_line(aes(x=time, y=casual_edge_count*2/vertex_count))+
        geom_line(aes(x=time, y=cas_n_edges*2/n))+
        xlab("time step")+ylab("mean degree")
```

#### Degree distribution.  
The simulated and target momentary degree distributions are below.

```{r, echo=FALSE, results='show'}
sim_deg_dist <- degreedist(cas_net)
names(sim_deg_dist) <- c("0", "1", "2")
target_deg_dist <- cas_deg_seq
names(target_deg_dist) <- c("0", "1", "2")

casual_deg_dist_data <- cbind(t(sim_deg_dist[1:3]), t(target_deg_dist[1:3]))
casual_deg_dist_data <- melt(casual_deg_dist_data, id.vars=c("degree0, degree1, degree2"))
casual_deg_dist_data <- cbind(casual_deg_dist_data, c(rep("simulated", 3), rep("target", 3)))
colnames(casual_deg_dist_data) <- c("ID", "degree", "value", "type")

ggplot(casual_deg_dist_data, aes(x=degree, y=value, fill=type))+
  geom_bar(position="dodge", stat="identity")+
  ylab("Number of Agents")

```

#### Partnership duration.
```{r, echo=TRUE, results='show'}
casual_partnerships <- partnership_event_data[which(partnership_event_data$network_type == 1),]
dim(casual_partnerships)

dis_casual_ptshps <- distinct(select(casual_partnerships, p1, p2))
sim_dur_form_dissolved <- NULL

for (i in 1:nrow(dis_casual_ptshps)){
  occur <- 
    intersect(which(casual_partnerships$p1 == dis_casual_ptshps$p1[i]),
            which(casual_partnerships$p2 == dis_casual_ptshps$p2[i])
            )
  
  if (length(occur) == 2){
    
    duration_new <- casual_partnerships$tick[max(occur)] - casual_partnerships$tick[min(occur)]
    
    sim_dur_form_dissolved <- c(sim_dur_form_dissolved, duration_new)
  
    }

  }

casual_sim_duration_form_dissolved <- sim_dur_form_dissolved
summary(casual_sim_duration_form_dissolved)
hist(casual_sim_duration_form_dissolved)
```

### Overlap between main and casual partnerships.
```{r, echo=FALSE, results='show'}

overlap_counts <- as.data.frame(
  cbind(counts_data$time, counts_data$overlaps/counts_data$main_edge_count)
  )
overlap_counts <- rbind(overlap_counts, 
                        cbind(counts_data$time, counts_data$overlaps/counts_data$casual_edge_count))
denominator <- c(rep("main", nrow(overlap_counts)/2), 
                 rep("casual", nrow(overlap_counts)/2)
                 )
overlap_counts <- cbind(overlap_counts, denominator)
overlap_counts <- as.data.frame(overlap_counts)
colnames(overlap_counts) <- c("time", "overlap", "denominator")

ggplot(overlap_counts, aes(x=time, y=overlap, color=denominator))+
  geom_line()

```

### Total mean degree: main and casual partnerships combined.

```{r, echo=FALSE, results='show'}
qplot(data=counts_data, x=time, 
      y=((main_edge_count*2/vertex_count)+
           (casual_edge_count*2/vertex_count)), 
      main="Sim 36", ylab=("total mean degree"),
      geom="line")
```

## ART metrics

The ART initiation portion was simplified so that all infected's initate ART 1 year after seroconversion. At presetnt, the proportion of the infected on ART was

```{r, results='asis'}
  on.art <- which(net%v%"art.status" == 1)
  length(on.art)
  length(on.art)/length(infected)
```

`r round(length(on.art)/length(infected), 2)`. The total proportion of all people in the population who were on ART is `r round(length(on.art)/length(infected)*prev, 2)`%.

## Biomarkers

Example CD4 and viral load trajectories for one person are below.

```{r, results='asis'}
   ## Selected upto n.to.follow infecteds at random
   n_to_follow <- 10
   infectees <- inf_event_data$infectee
   uniq_biom_pid <- unique(biom_data$p_id)

   infectee_uniq_biom_pid <- uniq_biom_pid[which(uniq_biom_pid %in% infectees)]
   new <- biom_data[which(biom_data$p_id == infectee_uniq_biom_pid[1]),]

   if (length(infectee_uniq_biom_pid > n_to_follow)){
     infectee_uniq_biom_pid <- infectee_uniq_biom_pid[1:n_to_follow]
   }
   
   for (i in 2:length(infectee_uniq_biom_pid)){
     new_entry <- biom_data[which(biom_data$p_id == infectee_uniq_biom_pid[i]),]
     new <- rbind(new, new_entry)
   }
   
   new$p_id <- as.character(new$p_id)

   par(mfrow=c(2,1))
   ggplot(new, aes(x=tick, y=viral_load, color=p_id))+
          geom_line()
   ggplot(new, aes(x=tick, y=cd4_count, color=p_id))+
          geom_line()

```

We see that this person's CD4 count and viral loads remain flat until timetep `r min(which(new$viral_load > 0)) - 1`, at which time he gets infected. His CD4 count starts to decline linearly, and his viral load undergoes the specified trajectory (i.e. quick initial rise during acute infection, decline to a stable state during chronic infection). At time 
`r min(which(new$art_status > 0))`, he goes on ART, and correspondingly, his CD4 count starts to rise, and viral load starts to decline. At time `r max(new$tick)`, he leaves the simulation on account of his death.

# Conclusion
As we add realistic empirical parameters for various remaining portions, in particular the behavior and ART/PrEP modules, our model will become more finely calibrated.
